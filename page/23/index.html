<!doctype html>



  


<html class="theme-next muse use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta property="og:type" content="website">
<meta property="og:title" content="杨子鳄的小窝">
<meta property="og:url" content="http://yangguoqi.me/page/23/index.html">
<meta property="og:site_name" content="杨子鳄的小窝">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="杨子鳄的小窝">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> 杨子鳄的小窝 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>
    <a target="_blank" href="https://github.com/lnmput"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/38ef81f8aca64bb9a64448d0d70f1308ef5341ab/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"></a>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">杨子鳄的小窝</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            简历
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/13/使用python操作elasticsearch/" itemprop="url">
                  使用python操作elasticsearch
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-12-13T10:19:01+08:00" content="2016-12-13">
              2016-12-13
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><blockquote class="blockquote-center"><br>和你们这些少爷不同，我们光是活着就竭尽全力了。<br></blockquote><br>Lately, here at Tryolabs, we started gaining interest in big data and search related platforms which are giving us excellent resources to create our complex web applications. One of them is Elasticsearch.<br>Elastic{ON}15, the first ES conference is coming, and since nowadays we see a lot of interest in this technology, we are taking the opportunity to give an introduction and a simple example for Python developers out there that want to begin using it or give it a try.</p>
<h3 id="1-What-is-Elasticsearch"><a href="#1-What-is-Elasticsearch" class="headerlink" title="1. What is Elasticsearch?"></a>1. What is Elasticsearch?</h3><p>Elasticsearch is a distributed, real-time, search and analytics platform.</p>
<h3 id="2-Yeah-but-what-IS-Elasticsearch"><a href="#2-Yeah-but-what-IS-Elasticsearch" class="headerlink" title="2. Yeah, but what IS Elasticsearch?"></a>2. Yeah, but what IS Elasticsearch?</h3><p>Good question! In the previous definition you can see all these hype-sounding tech terms (distributed, real-time, analytics), so let’s try to explain.<br>ES is distributed, it organizes information in clusters of nodes, so it will run in multiple servers if we intend it to.<br>ES is real-time, since data is indexed, we get responses to our queries super fast!<br>And last but not least, it does searches and analytics. The main problem we are solving with this tool is exploring our data!<br>A platform like ES is the foundation for any respectable search engine.</p>
<h3 id="3-How-does-it-work"><a href="#3-How-does-it-work" class="headerlink" title="3. How does it work?"></a>3. How does it work?</h3><p>Using a restful API, Elasticsearch saves data and indexes it automatically. It assigns types to fields and that way a search can be done smartly and quickly using filters and different queries.<br>It’s uses JVM in order to be as fast as possible. It distributes indexes in “shards” of data. It replicates shards in different nodes, so it’s distributed and clusters can function even if not all nodes are operational. Adding nodes is super easy and that’s what makes it so scalable.<br>ES uses Lucene to solve searches. This is quite an advantage with comparing with, for example, Django query strings. A restful API call allows us to perform searches using json objects as parameters, making it much more flexible and giving each search parameter within the object a different weight, importance and or priority.<br>The final result ranks objects that comply with the search query requirements. You could even use synonyms, autocompletes, spell suggestions and correct typos. While the usual query strings provides results that follow certain logic rules, ES queries give you a ranked list of results that may fall in different criteria and its order depend on how they comply with a certain rule or filter.<br>ES can also provide answers for data analysis, like averages, how many unique terms and or statistics. This could be done using aggregations. To dig a little deeper in this feature check the documentation here.</p>
<h3 id="4-Should-I-use-ES"><a href="#4-Should-I-use-ES" class="headerlink" title="4. Should I use ES?"></a>4. Should I use ES?</h3><p>The main point is scalability and getting results and insights very fast. In most cases using Lucene could be enough to have all you need.<br>It seems sometimes that these tools are designed for projects with tons of data and are distributed in order to handle tons of users. Startups dream of growing to that scenario, but may start thinking small first to build a prototype and then when the data is there, start thinking about scaling problems.<br>Does it make sense and pays off to be prepared to grow A LOT? Why not? Elasticsearch has no drawback and is easy to use, so it’s just a decision of using it to be prepared for the future.<br>I’m going to give you a quick example of a dead simple project using Elasticsearch to quickly and beautifully search for some example data. It will be quick to do, Python powered and ready to scale in case we need it to, so, best of both worlds.</p>
<h3 id="5-Easy-first-steps-with-ES"><a href="#5-Easy-first-steps-with-ES" class="headerlink" title="5. Easy first steps with ES"></a>5. Easy first steps with ES</h3><p>For the following part it would be nice to be familiarized with concepts like Cluster, Node, Document, Index. Take a look at the official guide if you have doubts.<br>First things first, get ES from here.<br>I followed this video tutorial to get things started in just a minute. I recommend all you to check it out later.<br>Once you downloaded ES, it’s as simple as running bin/elasticsearch and you will have your ES cluster with one node running! You can interact with it at <a href="http://localhost:9200/" target="_blank" rel="external">http://localhost:9200/</a><br>If you hit it you will get something like this:<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"status"</span> : <span class="number">200</span>,</div><div class="line">  <span class="attr">"name"</span> : <span class="string">"Delphine Courtney"</span>,</div><div class="line">  <span class="attr">"cluster_name"</span> : <span class="string">"elasticsearch"</span>,</div><div class="line">  <span class="attr">"version"</span> : &#123;</div><div class="line">    <span class="attr">"number"</span> : <span class="string">"1.4.2"</span>,</div><div class="line">    <span class="attr">"build_hash"</span> : <span class="string">"927caff6f05403e936c20bf4529f144f0c89fd8c"</span>,</div><div class="line">    <span class="attr">"build_timestamp"</span> : <span class="string">"2014-12-16T14:11:12Z"</span>,</div><div class="line">    <span class="attr">"build_snapshot"</span> : <span class="literal">false</span>,</div><div class="line">    <span class="attr">"lucene_version"</span> : <span class="string">"4.10.2"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"tagline"</span> : <span class="string">"You Know, for Search"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>view rawes_first.json hosted with ❤ by GitHub<br>Creating another node is as simple as:<br>bin/elasticsearch -Des.node.name=Node-2<br>It automatically detects the old node as its master and joins our cluster. By default we will be able to communicate with this new node using the 9201 port <a href="http://localhost:9201" target="_blank" rel="external">http://localhost:9201</a>. Now we can talk with each node and receive the same data, they are supposed to be identical.</p>
<h3 id="6-Let’s-Pythonize-this-thing"><a href="#6-Let’s-Pythonize-this-thing" class="headerlink" title="6. Let’s Pythonize this thing!"></a>6. Let’s Pythonize this thing!</h3><p>To use ES with our all time favorite language; Python, it gets easier if we install elasticsearch-py package.<br>pip install elasticsearch<br>Now we will be able to use this package to index and search data using Python.</p>
<h3 id="7-Let’s-add-some-public-data-to-our-cluster"><a href="#7-Let’s-add-some-public-data-to-our-cluster" class="headerlink" title="7. Let’s add some public data to our cluster"></a>7. Let’s add some public data to our cluster</h3><p>So, I wanted to make this project a “real world example”, I really did, but after I found out there is a star wars API (<a href="http://swapi.co/" target="_blank" rel="external">http://swapi.co/</a>), I couldn’t resist it and ended up being a fictional -  ”galaxy far far away” example.  The API is dead simple to use, so we will get some data from there.<br>I’m using an IPython Notebook to do this test, I started with the sample request to make sure we can hit the ES server.</p>
<h1 id="make-sure-ES-is-up-and-running"><a href="#make-sure-ES-is-up-and-running" class="headerlink" title="make sure ES is up and running"></a>make sure ES is up and running</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> requests</div><div class="line">res = requests.get(<span class="string">'http://localhost:9200'</span>)</div><div class="line">print(res.content)</div></pre></td></tr></table></figure>
<p>view rawes_first.py hosted with ❤ by GitHub<br>Then we connect to our ES server using Python and the elasticsearch-py library:</p>
<p>#connect to our cluster<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> elasticsearch <span class="keyword">import</span> Elasticsearch</div><div class="line">es = Elasticsearch([&#123;<span class="string">'host'</span>: <span class="string">'localhost'</span>, <span class="string">'port'</span>: <span class="number">9200</span>&#125;])</div></pre></td></tr></table></figure></p>
<p>view rawes_first3.py hosted with ❤ by GitHub<br>I added some data to test, and then deleted it. I’m skipping that part for this guide, but you can check it out in the notebook.<br>Now, using The Force, we connect to the Star Wars API and index some fictional people.</p>
<p>#let’s iterate over swapi people documents and index them<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> json</div><div class="line">r = requests.get(<span class="string">'http://localhost:9200'</span>) </div><div class="line">i = <span class="number">1</span></div><div class="line"><span class="keyword">while</span> r.status_code == <span class="number">200</span>:</div><div class="line">    r = requests.get(<span class="string">'http://swapi.co/api/people/'</span>+ str(i))</div><div class="line">    es.index(index=<span class="string">'sw'</span>, doc_type=<span class="string">'people'</span>, id=i, body=json.loads(r.content))</div><div class="line">    i=i+<span class="number">1</span></div><div class="line"> </div><div class="line">print(i)</div></pre></td></tr></table></figure></p>
<p>view rawes_first4.py hosted with ❤ by GitHub<br>Please, notice that we automatically created an index “sw” and a “doc_type” with de indexing command. We get 17 responses from swapi and index them with ES. I’m sure there are much more “people” in the swapi DB, but it seems we are getting a 404 with <a href="http://swapi.co/api/people/17" target="_blank" rel="external">http://swapi.co/api/people/17</a>. Bug report here! :-)<br>Anyway, to see if all worked with this few results, we try to get the document with id=5.<br>es.get(index=’sw’, doc_type=’people’, id=5)<br>view rawes_first10.py hosted with ❤ by GitHub<br>We will get Princess Leia:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">&#123;u'_id': u'5',</div><div class="line"> u'_index': u'sw',</div><div class="line"> u'_source': &#123;u'birth_year': u'19BBY',</div><div class="line">  u'created': u'2014-12-10T15:20:09.791000Z',</div><div class="line">  u'edited': u'2014-12-20T21:17:50.315000Z',</div><div class="line">  u'eye_color': u'brown',</div><div class="line">  u'films': [u'http://swapi.co/api/films/1/',</div><div class="line">   u'http://swapi.co/api/films/2/',</div><div class="line">   u'http://swapi.co/api/films/3/',</div><div class="line">   u'http://swapi.co/api/films/6/'],</div><div class="line">  u'gender': u'female',</div><div class="line">  u'hair_color': u'brown',</div><div class="line">  u'height': u'150',</div><div class="line">  u'homeworld': u'http://swapi.co/api/planets/2/',</div><div class="line">  u'mass': u'49',</div><div class="line">  u'name': u'Leia Organa',</div><div class="line">  u'skin_color': u'light',</div><div class="line">  u'species': [u'http://swapi.co/api/species/1/'],</div><div class="line">  u'starships': [],</div><div class="line">  u'url': u'http://swapi.co/api/people/5/',</div><div class="line">  u'vehicles': [u'http://swapi.co/api/vehicles/30/']&#125;,</div><div class="line"> u'_type': u'people',</div><div class="line"> u'_version': 1,</div><div class="line"> u'found': True&#125;</div></pre></td></tr></table></figure></p>
<p>view rawes_first5.py hosted with ❤ by GitHub<br>Now, let’s add more data, this time using node 2! And let’s start at the 18th person, where we stopped.<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">r = requests.get(<span class="string">'http://localhost:9201'</span>)</div><div class="line">i = <span class="number">18</span></div><div class="line"><span class="keyword">while</span> r.status_code == <span class="number">200</span>:</div><div class="line">   r = requests.get(<span class="string">'http://swapi.co/api/people/'</span>+ str(i))</div><div class="line">   es.index(index=<span class="string">'sw'</span>, doc_type=<span class="string">'people'</span>, id=i,     body=json.loads(r.content))</div><div class="line">   i=i+<span class="number">1</span></div></pre></td></tr></table></figure></p>
<p>view rawes_first6.py hosted with ❤ by GitHub<br>We got the rest of the characters just fine.</p>
<h3 id="8-Now-let’s-try-an-interesting-search"><a href="#8-Now-let’s-try-an-interesting-search" class="headerlink" title="8. Now, let’s try an interesting search"></a>8. Now, let’s try an interesting search</h3><p>Where is Darth Vader? Here is our search query:<br>es.search(index=”sw”, body={“query”: {“match”: {‘name’:’Darth Vader’}}})<br>view rawes_first7.py hosted with ❤ by GitHub<br>This will give us both Darth Vader AND Darth Maul. Id 4 and id 44 (notice that they are in the same index, even if we use different node client call the index command). Both results have a score, although Darth Vader is much higher than Darth Maul (2.77 vs 0.60) since Vader is a exact match. Take that Darth Maul!<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div></pre></td><td class="code"><pre><div class="line">&#123;u'_shards': &#123;u'failed': 0, u'successful': 5, u'total': 5&#125;,</div><div class="line"> u'hits': &#123;u'hits': [&#123;u'_id': u'4',</div><div class="line">    u'_index': u'sw',</div><div class="line">    u'_score': 2.7754524,</div><div class="line">    u'_source': &#123;u'birth_year': u'41.9BBY',</div><div class="line">     u'created': u'2014-12-10T15:18:20.704000Z',</div><div class="line">     u'edited': u'2014-12-20T21:17:50.313000Z',</div><div class="line">     u'eye_color': u'yellow',</div><div class="line">     u'films': [u'http://swapi.co/api/films/1/',</div><div class="line">      u'http://swapi.co/api/films/2/',</div><div class="line">      u'http://swapi.co/api/films/3/',</div><div class="line">      u'http://swapi.co/api/films/6/'],</div><div class="line">     u'gender': u'male',</div><div class="line">     u'hair_color': u'none',</div><div class="line">     u'height': u'202',</div><div class="line">     u'homeworld': u'http://swapi.co/api/planets/1/',</div><div class="line">     u'mass': u'136',</div><div class="line">     u'name': u'Darth Vader',</div><div class="line">     u'skin_color': u'white',</div><div class="line">     u'species': [u'http://swapi.co/api/species/1/'],</div><div class="line">     u'starships': [u'http://swapi.co/api/starships/13/'],</div><div class="line">     u'url': u'http://swapi.co/api/people/4/',</div><div class="line">     u'vehicles': []&#125;,</div><div class="line">    u'_type': u'people'&#125;,</div><div class="line">   &#123;u'_id': u'44',</div><div class="line">    u'_index': u'sw',</div><div class="line">    u'_score': 0.6085256,</div><div class="line">    u'_source': &#123;u'birth_year': u'54BBY',</div><div class="line">     u'created': u'2014-12-19T18:00:41.929000Z',</div><div class="line">     u'edited': u'2014-12-20T21:17:50.403000Z',</div><div class="line">     u'eye_color': u'yellow',</div><div class="line">     u'films': [u'http://swapi.co/api/films/4/'],</div><div class="line">     u'gender': u'male',</div><div class="line">     u'hair_color': u'none',</div><div class="line">     u'height': u'175',</div><div class="line">     u'homeworld': u'http://swapi.co/api/planets/36/',</div><div class="line">     u'mass': u'80',</div><div class="line">     u'name': u'Darth Maul',</div><div class="line">     u'skin_color': u'red',</div><div class="line">     u'species': [u'http://swapi.co/api/species/22/'],</div><div class="line">     u'starships': [u'http://swapi.co/api/starships/41/'],</div><div class="line">     u'url': u'http://swapi.co/api/people/44/',</div><div class="line">     u'vehicles': [u'http://swapi.co/api/vehicles/42/']&#125;,</div><div class="line">    u'_type': u'people'&#125;],</div><div class="line">  u'max_score': 2.7754524,</div><div class="line">  u'total': 2&#125;,</div><div class="line"> u'timed_out': False,</div><div class="line"> u'took': 44&#125;</div><div class="line">``` </div><div class="line">view rawes_first8.py hosted with ❤ by GitHub</div><div class="line">So, this query will give us results if the word is contained exactly in our indexed data. What if we want to build some kind of autocomplete input where we get the names that contain the characters we are typing?</div><div class="line">There are many ways to do that and another great number of queries. Take a look here to learn more. I picked this one to get all documents with prefix “lu” in their name field:</div><div class="line">`es.search(index="sw", body=&#123;"query": &#123;"prefix" : &#123; "name" : "lu" &#125;&#125;&#125;)`</div><div class="line">view rawes_first9.py hosted with ❤ by GitHub</div><div class="line">We will get Luke Skywalker and Luminara Unduli, both with the same 1.0 score, since they match with the same 2 initial characters.</div><div class="line">```json</div><div class="line">&#123;u'_shards': &#123;u'failed': 0, u'successful': 5, u'total': 5&#125;,</div><div class="line"> u'hits': &#123;u'hits': [&#123;u'_id': u'1',</div><div class="line">    u'_index': u'sw',</div><div class="line">    u'_score': 1.0,</div><div class="line">    u'_source': &#123;u'birth_year': u'19BBY',</div><div class="line">     u'created': u'2014-12-09T13:50:51.644000Z',</div><div class="line">     u'edited': u'2014-12-20T21:17:56.891000Z',</div><div class="line">     u'eye_color': u'blue',</div><div class="line">     u'films': [u'http://swapi.co/api/films/1/',</div><div class="line">      u'http://swapi.co/api/films/2/',</div><div class="line">      u'http://swapi.co/api/films/3/',</div><div class="line">      u'http://swapi.co/api/films/6/'],</div><div class="line">     u'gender': u'male',</div><div class="line">     u'hair_color': u'blond',</div><div class="line">     u'height': u'172',</div><div class="line">     u'homeworld': u'http://swapi.co/api/planets/1/',</div><div class="line">     u'mass': u'77',</div><div class="line">     u'name': u'Luke Skywalker',</div><div class="line">     u'skin_color': u'fair',</div><div class="line">     u'species': [u'http://swapi.co/api/species/1/'],</div><div class="line">     u'starships': [u'http://swapi.co/api/starships/12/',</div><div class="line">      u'http://swapi.co/api/starships/22/'],</div><div class="line">     u'url': u'http://swapi.co/api/people/1/',</div><div class="line">     u'vehicles': [u'http://swapi.co/api/vehicles/14/',</div><div class="line">      u'http://swapi.co/api/vehicles/30/']&#125;,</div><div class="line">    u'_type': u'people'&#125;,</div><div class="line">   &#123;u'_id': u'64',</div><div class="line">    u'_index': u'sw',</div><div class="line">    u'_score': 1.0,</div><div class="line">    u'_source': &#123;u'birth_year': u'58BBY',</div><div class="line">     u'created': u'2014-12-20T16:45:53.668000Z',</div><div class="line">     u'edited': u'2014-12-20T21:17:50.455000Z',</div><div class="line">     u'eye_color': u'blue',</div><div class="line">     u'films': [u'http://swapi.co/api/films/5/',</div><div class="line">      u'http://swapi.co/api/films/6/'],</div><div class="line">     u'gender': u'female',</div><div class="line">     u'hair_color': u'black',</div><div class="line">     u'height': u'170',</div><div class="line">     u'homeworld': u'http://swapi.co/api/planets/51/',</div><div class="line">     u'mass': u'56.2',</div><div class="line">     u'name': u'Luminara Unduli',</div><div class="line">     u'skin_color': u'yellow',</div><div class="line">     u'species': [u'http://swapi.co/api/species/29/'],</div><div class="line">     u'starships': [],</div><div class="line">     u'url': u'http://swapi.co/api/people/64/',</div><div class="line">     u'vehicles': []&#125;,</div><div class="line">    u'_type': u'people'&#125;],</div><div class="line">  u'max_score': 1.0,</div><div class="line">  u'total': 2&#125;,</div><div class="line"> u'timed_out': False,</div><div class="line"> u'took': 9&#125;</div></pre></td></tr></table></figure></p>
<p>view rawes_first11.py hosted with ❤ by GitHub<br>There are many other interesting queries we can do. If, for example, we want to get all elements similar in some way, for a related or correction search we can use something like this:<br>es.search(index=”sw”, body={“query”:<br>{“fuzzy_like_this_field” : { “name” :<br>{“like_text”: “jaba”, “max_query_terms”:5}}}})<br>view rawes_first1.py hosted with ❤ by GitHub<br>And we got Jabba although we had a typo in our search query. That is powerful!<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">&#123;u'_shards': &#123;u'failed': 0, u'successful': 5, u'total': 5&#125;,</div><div class="line"> u'hits': &#123;u'hits': [&#123;u'_id': u'16',</div><div class="line">    u'_index': u'sw',</div><div class="line">    u'_score': 1.5700331,</div><div class="line">    u'_source': &#123;u'birth_year': u'600BBY',</div><div class="line">     u'created': u'2014-12-10T17:11:31.638000Z',</div><div class="line">     u'edited': u'2014-12-20T21:17:50.338000Z',</div><div class="line">     u'eye_color': u'orange',</div><div class="line">     u'films': [u'http://swapi.co/api/films/1/',</div><div class="line">      u'http://swapi.co/api/films/3/',</div><div class="line">      u'http://swapi.co/api/films/4/'],</div><div class="line">     u'gender': u'hermaphrodite',</div><div class="line">     u'hair_color': u'n/a',</div><div class="line">     u'height': u'175',</div><div class="line">     u'homeworld': u'http://swapi.co/api/planets/24/',</div><div class="line">     u'mass': u'1,358',</div><div class="line">     u'name': u'Jabba Desilijic Tiure',</div><div class="line">     u'skin_color': u'green-tan, brown',</div><div class="line">     u'species': [u'http://swapi.co/api/species/5/'],</div><div class="line">     u'starships': [],</div><div class="line">     u'url': u'http://swapi.co/api/people/16/',</div><div class="line">     u'vehicles': []&#125;,</div><div class="line">    u'_type': u'people'&#125;],</div><div class="line">  u'max_score': 1.5700331,</div><div class="line">  u'total': 1&#125;,</div><div class="line"> u'timed_out': False,</div><div class="line"> u'took': 40&#125;</div></pre></td></tr></table></figure></p>
<p>view rawes_first2.py hosted with ❤ by GitHub</p>
<h3 id="9-Next-Steps"><a href="#9-Next-Steps" class="headerlink" title="9. Next Steps"></a>9. Next Steps</h3><p>This was just a simple overview on how to set up your Elasticsearch server and start working with some data using Python. The code used here is publicly available in this IPython notebook.<br>We encourage you to learn more about ES and specially take a look at the Elastic stack where you will be able to see beautiful analytics and insights with Kibana and go through logs using Logstash.<br>In following posts we will talk about more advanced ES features and we will try to extend this simple test and use it to show a more interesting Django app powered by this data and by ES.<br>Hope this post was useful for developers trying to enter the ES world.<br>At Tryolabs we’re Elastic official partners. If you want to talk about Elasticsearch, ELK, applications and possible projects using these technologies, drop us a line to hello@tryolabs.com (or fill out this form) and we will be glad to connect!</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/12/javascript中作用域和变量提升/" itemprop="url">
                  javascript中作用域和变量提升
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-12-12T16:35:59+08:00" content="2016-12-12">
              2016-12-12
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><blockquote class="blockquote-center"><br>留给中国队的时间已经不多了。<br></blockquote><br>“function函数”是一等公民！<code>编译阶段</code>，会把定义式的函数优先执行，也会把所有var变量创建，默认值为undefined，以提高程序的执行效率！<br>总结：当JavaScript引擎解析脚本时，它会在预编译期对所有声明的变量和函数进行处理！并且是先预声明变量，再预定义函数！</p>
<h3 id="变量提升"><a href="#变量提升" class="headerlink" title="变量提升"></a>变量提升</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> v=<span class="string">'Hello World'</span>;</div><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    alert(v);</div><div class="line">    <span class="keyword">var</span> v=<span class="string">'I love you'</span>;</div><div class="line">&#125;)()</div></pre></td></tr></table></figure>
<p>提示说“undefined”</p>
<h3 id="函数提升"><a href="#函数提升" class="headerlink" title="函数提升"></a>函数提升</h3><p>函数声明方式提升【成功】<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">myTest</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    foo();</div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>)</span>&#123;</div><div class="line">        alert(<span class="string">"我来自 foo"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">myTest();</div></pre></td></tr></table></figure></p>
<p>函数表达式方式提升【失败】<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">myTest</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    foo();</div><div class="line">   <span class="keyword">var</span> foo =<span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>)</span>&#123;</div><div class="line">        alert(<span class="string">"我来自 foo"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">myTest();</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/09/python投票和ip地址的伪造/" itemprop="url">
                  python投票和ip地址的伪造
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-12-09T10:30:46+08:00" content="2016-12-09">
              2016-12-09
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><blockquote class="blockquote-center"><br>全怪我们太穷了，又不认识人。<br></blockquote></p>
<h3 id="项目说明"><a href="#项目说明" class="headerlink" title="项目说明"></a>项目说明</h3><ul>
<li>投票地址：<a href="http://kepudasai.cdstm.cn/index.php?kepu-postvote" target="_blank" rel="external">http://kepudasai.cdstm.cn/index.php?kepu-postvote</a></li>
<li>投票限制：IP，每个ip每天10票</li>
<li>提交方式：post</li>
<li>提交参数：{‘group’: ‘gaozhongzu’,’key’ : 10}</li>
</ul>
<h3 id="php获取IP问题"><a href="#php获取IP问题" class="headerlink" title="php获取IP问题"></a>php获取IP问题</h3><p>一般我们写的获取ip的方式：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">GetIP</span><span class="params">()</span></span>&#123;</div><div class="line">    <span class="keyword">if</span> (!<span class="keyword">empty</span>($_SERVER[<span class="string">"HTTP_CLIENT_IP"</span>])) &#123;</div><div class="line">        $cip = $_SERVER[<span class="string">"HTTP_CLIENT_IP"</span>];</div><div class="line">    &#125; <span class="keyword">elseif</span> (!<span class="keyword">empty</span>($_SERVER[<span class="string">"HTTP_X_FORWARDED_FOR"</span>])) &#123;</div><div class="line">        $cip = $_SERVER[<span class="string">"HTTP_X_FORWARDED_FOR"</span>];</div><div class="line">    &#125; <span class="keyword">elseif</span> (!<span class="keyword">empty</span>($_SERVER[<span class="string">"REMOTE_ADDR"</span>])) &#123;</div><div class="line">        $cip = $_SERVER[<span class="string">"REMOTE_ADDR"</span>];</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        $cip = <span class="string">"0.0.0.0"</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> $cip;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其实这是有问题的，通过header我们可以轻易改变ip：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">$curl = curl_init();    <span class="comment">//初始化一个curl对象  </span></div><div class="line">curl_setopt($curl, CURLOPT_URL, <span class="string">"127.0.0.1/server.php"</span>); </div><div class="line">$header = <span class="keyword">array</span>(        <span class="comment">//构造头部</span></div><div class="line">    <span class="string">'CLIENT-IP:58.68.44.61'</span>, </div><div class="line">    <span class="string">'X-FORWARDED-FOR:58.68.44.61'</span>, </div><div class="line">); </div><div class="line"></div><div class="line">curl_setopt($curl, CURLOPT_HTTPHEADER, $header); </div><div class="line">curl_setopt($curl, CURLOPT_RETURNTRANSFER, <span class="keyword">true</span>); </div><div class="line"></div><div class="line">$str = curl_exec($curl);    <span class="comment">//执行请求  </span></div><div class="line">curl_close($curl);    <span class="comment">//关闭c</span></div><div class="line"><span class="keyword">echo</span> $str;    <span class="comment">//输出抓取的结果</span></div></pre></td></tr></table></figure></p>
<p>解决方法：<br>在判断的时候以$_SERVER[“REMOTE_ADDR”]优先。</p>
<h3 id="python脚本"><a href="#python脚本" class="headerlink" title="python脚本"></a>python脚本</h3><p>初学，不喜勿喷<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> threading</div><div class="line"><span class="keyword">import</span> random</div><div class="line"><span class="keyword">import</span> socket</div><div class="line"><span class="keyword">import</span> struct</div><div class="line"><span class="keyword">import</span> requests</div><div class="line"><span class="keyword">import</span> json</div><div class="line"><span class="keyword">import</span> time</div><div class="line"></div><div class="line">url = <span class="string">'http://kepudasai.cdstm.cn/index.php?kepu-postvote'</span></div><div class="line"></div><div class="line">data = &#123;<span class="string">'group'</span>: <span class="string">'gaozhongzu'</span>,<span class="string">'key'</span> : <span class="number">10</span>&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">createHeader</span><span class="params">()</span>:</span></div><div class="line">    ip = socket.inet_ntoa(struct.pack(<span class="string">'&gt;I'</span>, random.randint(<span class="number">1</span>, <span class="number">0xffffffff</span>)))</div><div class="line">    headers = &#123;</div><div class="line">        <span class="string">'Content-Type'</span>: <span class="string">'application/x-www-form-urlencoded'</span>,</div><div class="line">        <span class="string">'User-Agent'</span>: <span class="string">'Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Trident/5.0'</span>,</div><div class="line">        <span class="string">'CLIENT-IP'</span>: ip,</div><div class="line">        <span class="string">'X-FORWARDED-FOR'</span>: ip</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> headers</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">toupiao</span><span class="params">()</span>:</span></div><div class="line">    index = <span class="number">0</span></div><div class="line">    headers = createHeader();</div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        html = requests.post(url, data=data, headers=headers)</div><div class="line">        result = json.loads(html.text)</div><div class="line">        <span class="keyword">if</span>(result[<span class="string">'error'</span>] == <span class="number">1</span>):</div><div class="line">            time.sleep(random.randint(<span class="number">1</span>, <span class="number">3</span>))</div><div class="line">            headers = createHeader();</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            index += <span class="number">1</span></div><div class="line">        <span class="keyword">if</span>(index == <span class="number">10000</span>):</div><div class="line">            <span class="keyword">print</span> index</div><div class="line">            <span class="keyword">break</span></div><div class="line"></div><div class="line">toupiao()</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/08/关于http的一些知识/" itemprop="url">
                  关于http的一些知识
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-12-08T15:35:42+08:00" content="2016-12-08">
              2016-12-08
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><blockquote class="blockquote-center"><br>兴趣是最好的老师，其次是耻辱<br></blockquote></p>
<h3 id="简要说明"><a href="#简要说明" class="headerlink" title="简要说明"></a>简要说明</h3><p>简言之，HTTP Referer是header的一部分，当浏览器向web服务器发送请求的时候，一般会带上Referer，告诉服务器我是从哪个页面链接过来的，服务器籍此可以获得一些信息用于处理。比如从我主页上链接到一个朋友那里，他的服务器就能够从HTTP Referer中统计出每天有多少用户点击我主页上的链接访问他的网站。</p>
<p>从一个https页面上的链接访问到一个非加密的http页面的时候，在http页面上是检查不到HTTP Referer的，比如当我点击自己的https页面下面的w3c xhtml验证图标（网址为<a href="http://validator.w3.org/check?uri=referer），从来都无法完成校验，提示：" target="_blank" rel="external">http://validator.w3.org/check?uri=referer），从来都无法完成校验，提示：</a></p>
<p>No Referer header found!<br>原来，在http协议的rfc文档中有定义：</p>
<p>15.1.3 Encoding Sensitive Information in URI’s</p>
<p>…</p>
<p>   Clients SHOULD NOT include a Referer header field in a (non-secure)<br>   HTTP request if the referring page was transferred with a secure<br>   protocol.<br>这样是出于安全的考虑，访问非加密页时，如果来源是加密页，客户端不发送Referer，IE一直都是这样实现的，Firefox浏览器也不例外。但这并不影响从加密页到加密页的访问。</p>
<h3 id="详细论述"><a href="#详细论述" class="headerlink" title="详细论述"></a>详细论述</h3><p>从一个https页面上的链接访问到一个非加密的http页面的时候，在http页面上是检查不到HTTP Referer的，但是这是在https中未做设置的情况下，如facebook，</p>
<ul>
<li><a href="http://serverfault.com/questions/520244/referer-is-passed-from-https-to-http-in-some-cases-how" target="_blank" rel="external">http://serverfault.com/questions/520244/referer-is-passed-from-https-to-http-in-some-cases-how</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/07/常见性能优化策略的总结/" itemprop="url">
                  常见性能优化策略的总结
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-12-07T17:57:56+08:00" content="2016-12-07">
              2016-12-07
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><blockquote class="blockquote-center"><br>我们走得太快，灵魂都跟不上了 …<br></blockquote></p>
<h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><p>之所以把代码放到第一位，是因为这一点最容易引起技术人员的忽视。很多技术人员拿到一个性能优化的需求以后，言必称缓存、异步、JVM等。实际上，第一步就应该是分析相关的代码，找出相应的瓶颈，再来考虑具体的优化策略。有一些性能问题，完全是由于代码写的不合理，通过直接修改一下代码就能解决问题的，比如for循环次数过多、作了很多无谓的条件判断、相同逻辑重复多次等。</p>
<h3 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h3><p>数据库的调优，总的来说分为以下三部分：</p>
<ul>
<li><p>SQL调优<br>这是最常用、每一个技术人员都应该掌握基本的SQL调优手段（包括方法、工具、辅助系统等）。这里以MySQL为例，最常见的方式是，由自带的慢查询日志或者开源的慢查询系统定位到具体的出问题的SQL，然后使用explain、profile等工具来逐步调优，最后经过测试达到效果后上线。这方面的细节，可以参考MySQL索引原理及慢查询优化。</p>
</li>
<li><p>架构层面的调优<br>这一类调优包括读写分离、多从库负载均衡、水平和垂直分库分表等方面，一般需要的改动较大，但是频率没有SQL调优高，而且一般需要DBA来配合参与。那么什么时候需要做这些事情？我们可以通过内部监控报警系统（比如Zabbix），定期跟踪一些指标数据是否达到瓶颈，一旦达到瓶颈或者警戒值，就需要考虑这些事情。通常，DBA也会定期监控这些指标值。</p>
</li>
<li><p>连接池调优<br>我们的应用为了实现数据库连接的高效获取、对数据库连接的限流等目的，通常会采用连接池类的方案，即每一个应用节点都管理了一个到各个数据库的连接池。随着业务访问量或者数据量的增长，原有的连接池参数可能不能很好地满足需求，这个时候就需要结合当前使用连接池的原理、具体的连接池监控数据和当前的业务量作一个综合的判断，通过反复的几次调试得到最终的调优参数。</p>
</li>
</ul>
<h3 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h3><ul>
<li>本地缓存（HashMap/ConcurrentHashMap、Ehcache、Guava Cache等），缓存服务（Redis/Tair/Memcache等）。</li>
</ul>
<p>使用场景<br>什么情况适合用缓存？考虑以下两种场景：</p>
<p>短时间内相同数据重复查询多次且数据更新不频繁，这个时候可以选择先从缓存查询，查询不到再从数据库加载并回设到缓存的方式。此种场景较适合用单机缓存。<br>高并发查询热点数据，后端数据库不堪重负，可以用缓存来扛。<br>选型考虑<br>如果数据量小，并且不会频繁地增长又清空（这会导致频繁地垃圾回收），那么可以选择本地缓存。具体的话，如果需要一些策略的支持（比如缓存满的逐出策略），可以考虑Ehcache；如不需要，可以考虑HashMap；如需要考虑多线程并发的场景，可以考虑ConcurentHashMap。<br>其他情况，可以考虑缓存服务。目前从资源的投入度、可运维性、是否能动态扩容以及配套设施来考虑，我们优先考虑Tair。除非目前Tair还不能支持的场合（比如分布式锁、Hash类型的value），我们考虑用Redis。<br>设计关键点<br>什么时候更新缓存？如何保障更新的可靠性和实时性？<br>更新缓存的策略，需要具体问题具体分析。这里以门店POI的缓存数据为例，来说明一下缓存服务型的缓存更新策略是怎样的？目前约10万个POI数据采用了Tair作为缓存服务，具体更新的策略有两个：</p>
<p>接收门店变更的消息，准实时更新。<br>给每一个POI缓存数据设置5分钟的过期时间，过期后从DB加载再回设到DB。这个策略是对第一个策略的有力补充，解决了手动变更DB不发消息、接消息更新程序临时出错等问题导致的第一个策略失效的问题。通过这种双保险机制，有效地保证了POI缓存数据的可靠性和实时性。<br>缓存是否会满，缓存满了怎么办？<br>对于一个缓存服务，理论上来说，随着缓存数据的日益增多，在容量有限的情况下，缓存肯定有一天会满的。如何应对？<br>① 给缓存服务，选择合适的缓存逐出算法，比如最常见的LRU。<br>② 针对当前设置的容量，设置适当的警戒值，比如10G的缓存，当缓存数据达到8G的时候，就开始发出报警，提前排查问题或者扩容。<br>③ 给一些没有必要长期保存的key，尽量设置过期时间。</p>
<p>缓存是否允许丢失？丢失了怎么办？<br>根据业务场景判断，是否允许丢失。如果不允许，就需要带持久化功能的缓存服务来支持，比如Redis或者Tair。更细节的话，可以根据业务对丢失时间的容忍度，还可以选择更具体的持久化策略，比如Redis的RDB或者AOF。</p>
<p>缓存被“击穿”问题<br>对于一些设置了过期时间的key，如果这些key可能会在某些时间点被超高并发地访问，是一种非常“热点”的数据。这个时候，需要考虑另外一个问题：缓存被“击穿”的问题。</p>
<p>概念：缓存在某个时间点过期的时候，恰好在这个时间点对这个Key有大量的并发请求过来，这些请求发现缓存过期一般都会从后端DB加载数据并回设到缓存，这个时候大并发的请求可能会瞬间把后端DB压垮。<br>如何解决：业界比较常用的做法，是使用mutex。简单地来说，就是在缓存失效的时候（判断拿出来的值为空），不是立即去load db，而是先使用缓存工具的某些带成功操作返回值的操作（比如Redis的SETNX或者Memcache的ADD）去set一个mutex key，当操作返回成功时，再进行load db的操作并回设缓存；否则，就重试整个get缓存的方法。类似下面的代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">get</span><span class="params">(key)</span> </span>&#123;</div><div class="line">    String value = redis.get(key);</div><div class="line">    <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123; <span class="comment">//代表缓存值过期</span></div><div class="line">        <span class="comment">//设置3min的超时，防止del操作失败的时候，下次缓存过期一直不能load db</span></div><div class="line">        <span class="keyword">if</span> (redis.setnx(key_mutex, <span class="number">1</span>, <span class="number">3</span> * <span class="number">60</span>) == <span class="number">1</span>) &#123;  <span class="comment">//代表设置成功</span></div><div class="line">             value = db.get(key);</div><div class="line">                    redis.set(key, value, expire_secs);</div><div class="line">                    redis.del(key_mutex);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;  <span class="comment">//这个时候代表同时候的其他线程已经load db并回设到缓存了，这时候重试获取缓存值即可</span></div><div class="line">                    sleep(<span class="number">50</span>);</div><div class="line">                    get(key);  <span class="comment">//重试</span></div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> value;      </div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="异步"><a href="#异步" class="headerlink" title="异步"></a>异步</h3><p>使用场景<br>针对某些客户端的请求，在服务端可能需要针对这些请求做一些附属的事情，这些事情其实用户并不关心或者用户不需要立即拿到这些事情的处理结果，这种情况就比较适合用异步的方式处理这些事情。</p>
<p>作用<br>缩短接口响应时间，使用户的请求快速返回，用户体验更好。<br>避免线程长时间处于运行状态，这样会引起服务线程池的可用线程长时间不够用，进而引起线程池任务队列长度增大，从而阻塞更多请求任务，使得更多请求得不到技术处理。<br>线程长时间处于运行状态，可能还会引起系统Load、CPU使用率、机器整体性能下降等一系列问题，甚至引发雪崩。异步的思路可以在不增加机器数和CPU数的情况下，有效解决这个问题。<br>常见做法<br>一种做法，是额外开辟线程，这里可以采用额外开辟一个线程或者使用线程池的做法，在IO线程（处理请求响应）之外的线程来处理相应的任务，在IO线程中让response先返回。</p>
<p>如果异步线程处理的任务设计的数据量非常巨大，那么可以引入阻塞队列BlockingQueue作进一步的优化。具体做法是让一批异步线程不断地往阻塞队列里扔数据，然后额外起一个处理线程，循环批量从队列里拿预设大小的一批数据，来进行批处理（比如发一个批量的远程服务请求），这样进一步提高了性能。</p>
<p>另一种做法，是使用消息队列（MQ）中间件服务，MQ天生就是异步的。一些额外的任务，可能不需要我这个系统来处理，但是需要其他系统来处理。这个时候可以先把它封装成一个消息，扔到消息队列里面，通过消息中间件的可靠性保证把消息投递到关心它的系统，然后让这个系统来做相应的处理。</p>
<p>比如C端在完成一个提单动作以后，可能需要其它端做一系列的事情，但是这些事情的结果不会立刻对C端用户产生影响，那么就可以先把C端下单的请求响应先返回给用户，返回之前往MQ中发一个消息即可。而且这些事情理应不是C端的负责范围，所以这个时候用MQ的方式，来解决这个问题最合适。</p>
<h3 id="NoSQL"><a href="#NoSQL" class="headerlink" title="NoSQL"></a>NoSQL</h3><p>和缓存的区别<br>先说明一下，这里介绍的和缓存那一节不一样，虽然可能会使用一样的数据存储方案（比如Redis或者Tair），但是使用的方式不一样，这一节介绍的是把它作为DB来用。如果当作DB来用，需要有效保证数据存储方案的可用性、可靠性。</p>
<p>使用场景<br>需要结合具体的业务场景，看这块业务涉及的数据是否适合用NoSQL来存储，对数据的操作方式是否适合用NoSQL的方式来操作，或者是否需要用到NoSQL的一些额外特性（比如原子加减等）。</p>
<p>如果业务数据不需要和其他数据作关联，不需要事务或者外键之类的支持，而且有可能写入会异常频繁，这个时候就比较适合用NoSQL（比如HBase）。</p>
<p>比如，美团点评内部有一个对exception做的监控系统，如果在应用系统发生严重故障的时候，可能会短时间产生大量exception数据，这个时候如果选用MySQL，会造成MySQL的瞬间写压力飙升，容易导致MySQL服务器的性能急剧恶化以及主从同步延迟之类的问题，这种场景就比较适合用Hbase类似的NoSQL来存储。</p>
<h3 id="JVM调优"><a href="#JVM调优" class="headerlink" title="JVM调优"></a>JVM调优</h3><p>什么时候调？<br>通过监控系统（如没有现成的系统，自己做一个简单的上报监控的系统也很容易）上对一些机器关键指标（gc time、gc count、各个分代的内存大小变化、机器的Load值与CPU使用率、JVM的线程数等）的监控报警，也可以看gc log和jstat等命令的输出，再结合线上JVM进程服务的一些关键接口的性能数据和请求体验，基本上就能定位出当前的JVM是否有问题，以及是否需要调优。</p>
<p>怎么调？<br>如果发现高峰期CPU使用率与Load值偏大，这个时候可以观察一些JVM的thread count以及gc count（可能主要是young gc count），如果这两个值都比以往偏大（也可以和一个历史经验值作对比），基本上可以定位是young gc频率过高导致，这个时候可以通过适当增大young区大小或者占比的方式来解决。<br>如果发现关键接口响应时间很慢，可以结合gc time以及gc log中的stop the world的时间，看一下整个应用的stop the world的时间是不是比较多。如果是，可能需要减少总的gc time，具体可以从减小gc的次数和减小单次gc的时间这两个维度来考虑，一般来说，这两个因素是一对互斥因素，我们需要根据实际的监控数据来调整相应的参数（比如新生代与老生代比值、eden与survivor比值、MTT值、触发cms回收的old区比率阈值等）来达到一个最优值。<br>如果发生full gc或者old cms gc非常频繁，通常这种情况会诱发STW的时间相应加长，从而也会导致接口响应时间变慢。这种情况，大概率是出现了“内存泄露”，Java里的内存泄露指的是一些应该释放的对象没有被释放掉（还有引用拉着它）。那么这些对象是如何产生的呢？为啥不会释放呢？对应的代码是不是出问题了？问题的关键是搞明白这个，找到相应的代码，然后对症下药。所以问题的关键是转化成寻找这些对象。怎么找？综合使用jmap和MAT，基本就能定位到具体的代码。<br>多线程与分布式<br>使用场景<br>离线任务、异步任务、大数据任务、耗时较长任务的运行**，适当地利用，可达到加速的效果。</p>
<p>注意：线上对响应时间要求较高的场合，尽量少用多线程，尤其是服务线程需要等待任务线程的场合（很多重大事故就是和这个息息相关），如果一定要用，可以对服务线程设置一个最大等待时间。</p>
<p>常见做法<br>如果单机的处理能力可以满足实际业务的需求，那么尽可能地使用单机多线程的处理方式，减少复杂性；反之，则需要使用多机多线程的方式。</p>
<p>对于单机多线程，可以引入线程池的机制，作用有二：</p>
<p>提高性能，节省线程创建和销毁的开销<br>限流，给线程池一个固定的容量，达到这个容量值后再有任务进来，就进入队列进行排队，保障机器极限压力下的稳定处理能力在使用JDK自带的线程池时，一定要仔细理解构造方法的各个参数的含义，如core pool size、max pool size、keepAliveTime、worker queue等，在理解的基础上通过不断地测试调整这些参数值达到最优效果。<br>如果单机的处理能力不能满足需求，这个时候需要使用多机多线程的方式。这个时候就需要一些分布式系统的知识了。首先就必须引入一个单独的节点，作为调度器，其他的机器节点都作为执行器节点。调度器来负责拆分任务，和分发任务到合适的执行器节点；执行器节点按照多线程的方式（也可能是单线程）来执行任务。这个时候，我们整个任务系统就由单击演变成一个集群的系统，而且不同的机器节点有不同的角色，各司其职，各个节点之间还有交互。这个时候除了有多线程、线程池等机制，像RPC、心跳等网络通信调用的机制也不可少。后续我会出一个简单的分布式调度运行的框架。</p>
<p>度量系统（监控、报警、服务依赖管理）<br>严格来说，度量系统不属于性能优化的范畴，但是这方面和性能优化息息相关，可以说为性能优化提供一个强有力的数据参考和支撑。没有度量系统，基本上就没有办法定位到系统的问题，也没有办法有效衡量优化后的效果。很多人不重视这方面，但我认为它是系统稳定性和性能保障的基石。</p>
<p>关键流程<br>如果要设计这套系统，总体来说有哪些关键流程需要设计呢？<br>① 确定指标<br>② 采集数据<br>③ 计算数据，存储结果<br>④ 展现和分析</p>
<p>需要监控和报警哪些指标数据？需要关注哪些？<br>按照需求出发，主要需要二方面的指标：</p>
<p>接口性能相关，包括单个接口和全部的QPS、响应时间、调用量（统计时间维度越细越好；最好是，既能以节点为维度，也可以以服务集群为维度，来查看相关数据）。其中还涉及到服务依赖关系的管理，这个时候需要用到服务依赖管理系统<br>单个机器节点相关，包括CPU使用率、Load值、内存占用率、网卡流量等。如果节点是一些特殊类型的服务（比如MySQL、Redis、Tair），还可以监控这些服务特有的一些关键指标。<br>数据采集方式<br>通常采用异步上报的方式，具体做法有两种：第一种，发到本地的Flume端口，由Flume进程收集到远程的Hadoop集群或者Storm集群来进行运算；第二种，直接在本地运算好以后，使用异步和本地队列的方式，发送到监控服务器。</p>
<p>数据计算<br>可以采用离线运算（MapReduce/Hive）或者实时/准实时运算（Storm/Spark）的方式，运算后的结果存入MySQL或者HBase；某些情况，也可以不计算，直接采集发往监控服务器。</p>
<p>展现和分析<br>提供统一的展现分析平台，需要带报表（列表/图表）监控和报警的功能。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/22/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/22/">22</a><span class="page-number current">23</span><a class="page-number" href="/page/24/">24</a><span class="space">&hellip;</span><a class="page-number" href="/page/35/">35</a><a class="extend next" rel="next" href="/page/24/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="lnmput@gmail.com" />
          <p class="site-author-name" itemprop="name">lnmput@gmail.com</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">174</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">86</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/lnmput" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              友情链接
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.laruence.com/" title="风雪之隅" target="_blank">风雪之隅</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://tech.youzan.com/" title="有赞技术团队" target="_blank">有赞技术团队</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://tech.meituan.com/archives" title="美团点评技术团队" target="_blank">美团点评技术团队</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://macshuo.com/" title="點燈坊" target="_blank">點燈坊</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://blog.turn.tw/" title="轉個彎日誌" target="_blank">轉個彎日誌</a>
                </li>
              
            </ul>
          </div>
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2016 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">lnmput@gmail.com</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  



  
  
  

  

  

</body>
</html>
